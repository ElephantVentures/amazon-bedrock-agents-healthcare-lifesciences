# Alternative Dockerfile for Apple Silicon (ARM64) users
# This version uses native ARM64 builds for better performance

FROM python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    zip \
    unzip \
    jq \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install AWS CLI v2 for ARM64
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip" \
    && unzip awscliv2.zip \
    && ./aws/install \
    && rm -rf aws awscliv2.zip

# Create Python virtual environment and install dependencies
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install Python dependencies
COPY requirements-deployment.txt /tmp/
RUN pip install --no-cache-dir -r /tmp/requirements-deployment.txt

# Create non-root user for security
RUN groupadd -r deploy && useradd -r -g deploy deploy

# Set working directory
WORKDIR /workspace

# Copy deployment files
COPY --chown=deploy:deploy . .

# Make scripts executable
RUN chmod +x deploy.sh docker-deploy.sh

# Switch to non-root user
USER deploy

# Set default environment variables
ENV AWS_DEFAULT_REGION=us-east-2
ENV AWS_PAGER=""
ENV PYTHONUNBUFFERED=1

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD aws --version || exit 1

# Default command
CMD ["./deploy.sh"]
